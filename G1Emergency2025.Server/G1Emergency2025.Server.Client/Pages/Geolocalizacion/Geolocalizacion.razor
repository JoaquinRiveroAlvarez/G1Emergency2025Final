@page "/geolocalizacion"
@page "/geolocalizacion/{eventoId:int}"

@using G1Emergency2025.Shared.DTO
@inject IHttpServicio Http
@inject NavigationManager Nav

<h3>Geolocalización</h3>

<div class="mt-3">
    <button class="btn btn-secondary" @onclick="VolverAEvento">← Volver a Evento</button>
</div>
<div class="map-container">
    <img src="images/mapacordoba.jpg" class="map-image" />

    @foreach (var movil in moviles)
    {
        if (posiciones.TryGetValue(movil.Id, out var p))
        {
            <div class="ambulancia-icon"
                 style="top:@p.Top%; left:@p.Left%;"
                 @onclick="() => MostrarModal(movil)">
                🚑
            </div>
        }
    }
</div>

@if (movilSeleccionado != null)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Móvil @movilSeleccionado.Patente</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <p><b>Tipo:</b> @movilSeleccionado.TipoMovil</p>
                    <p><b>Disponibilidad:</b> @movilSeleccionado.disponibilidadMovil</p>

                    @if (movilSeleccionado.disponibilidadMovil == DisponibilidadMovil.libre)
                    {
                        <button class="btn btn-primary mt-2" @onclick="() => AsignarMovil(movilSeleccionado.Id)">
                            Asignar este móvil al evento
                        </button>
                    }
                    else
                    {
                        <p class="text-muted mt-2">Este móvil no está disponible para asignar.</p>
                    }

                </div>
            </div>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(mensaje))
{
    <div class="alert alert-info mt-3">@mensaje</div>
}



<div class="contenedor-moviles mt-3">
    <h5 class="titulo-moviles">Listado de Móviles</h5>
    <ul class="list-group lista-moviles">
        @foreach (var movil in moviles)
        {
            <li class="list-group-item py-1 px-2">
                🚑 @movil.Patente - @movil.TipoMovil (@movil.disponibilidadMovil)
            </li>
        }
    </ul>
</div>


@code {
    [Parameter]
    public int eventoId { get; set; }

    private List<MovilListadoDTO> moviles = new();
    private Dictionary<int, Posicion> posiciones = new();
    private MovilListadoDTO? movilSeleccionado;
    
    private string mensaje = string.Empty;
    private List<Posicion> coordenadasCordoba = new()
{
    new Posicion { Top = 28, Left = 42 }, // Hospital Córdoba
    new Posicion { Top = 35, Left = 50 }, // Plaza San Martín
    new Posicion { Top = 40, Left = 60 }, // Av. Colón
    new Posicion { Top = 45, Left = 38 }, // Nueva Córdoba
    new Posicion { Top = 32, Left = 55 }, // Barrio General Paz
    new Posicion { Top = 50, Left = 48 }, // Ciudad Universitaria
};


    protected override async Task OnInitializedAsync()
    {

        var resultado = await Http.Get<List<MovilListadoDTO>>("api/Movil/ListaMovil");

        if (!resultado.Error)
        {
            moviles = resultado.Respuesta ?? new List<MovilListadoDTO>();
        }
        else
        {
            mensaje = resultado.ObtenerError();
            moviles = new List<MovilListadoDTO>();
        }


        for (int i = 0; i < moviles.Count; i++)
        {
            posiciones[moviles[i].Id] = coordenadasCordoba[i % coordenadasCordoba.Count];
        }

    }

    private async Task AsignarMovil(int movilId)
    {
        var dto = new AsignarMovilesEventoDTO
        {
            MovilIds = new List<int> { movilId }
        };

        var response = await Http.Put<AsignarMovilesEventoDTO, object>(
            $"api/evento/{eventoId}/AsignarMovilesEvento", dto);

        if (!response.Error)
        {
            mensaje = "Móvil asignado correctamente";
            Nav.NavigateTo($"/geolocalizacion/{eventoId}");
        }

        else
        {
            mensaje = response.ObtenerError();
        }
    }


    private void MostrarModal(MovilListadoDTO movil) => movilSeleccionado = movil;
    private void CerrarModal() => movilSeleccionado = null;

    private class Posicion
    {
        public double Top { get; set; }
        public double Left { get; set; }
    }

    private void VolverAEvento() => Nav.NavigateTo("/eventos");


}
