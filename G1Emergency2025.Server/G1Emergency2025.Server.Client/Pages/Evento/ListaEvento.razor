@page "/eventos"
@using System.Text.Json
@inject IHttpServicio Http
@inject NavigationManager Nav

<h3 class="text-light">Lista de Eventos</h3>

<div class="mb-3 d-flex align-items-center gap-3">
    <a class="btn btn-danger"
       href="/eventos/crear"
       title="Nuevo Evento">
        +
    </a>

    <button class="btn btn-outline-light"
            @onclick="AlternarVista">
        @(mostrarTodos
                ? "Ver eventos de las últimas 24 hs"
                : "Ver historial")
    </button>

    <NavLink href="/geolocalizacion" title="Geolocalización" class="text-primary fs-4">
        <i class="fas fa-earth-americas"></i>
    </NavLink>
</div>


@if (eventos == null)
{
    <div class="alert alert-secondary">Buscando...</div>
}
else if (eventos.Count == 0)
{
    <div class="alert alert-warning">No hay Eventos cargados en esta lista</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-hover text-light">

            <thead class="table-dark">
                <tr>
                    
                    
                    <th>Ubicación</th>
                    <th>Teléfono</th>
                    <th>Fecha</th>
                    <th>Paciente</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var evento in eventos)
                {
                    var colorClase = evento.colorEvento switch
                    {
                        ColorEvento.Rojo => "bg-danger",
                        ColorEvento.Amarillo => "bg-warning text-dark",
                        ColorEvento.Verde => "bg-success",
                      
                        _ => "bg-secondary"
                    };

                    <tr class="@colorClase">
                        

                        <td>@evento.Ubicacion</td>
                        <td>@evento.Telefono</td>
                        <td>
                            @evento.FechaHora.ToString("dd/MM/yyyy") <br />
                            <small class="text-light">@evento.FechaHora.ToString("HH:mm:ss")</small>
                        </td>

                        <td class="align-middle">
                            @if (evento.Pacientes != null && evento.Pacientes.Any())
                            {
                                @foreach (var p in evento.Pacientes)
                                {
                                    <a class="btn btn-sm btn-outline-light me-1"
                                       title="Datos del paciente"
                                       href="/paciente/detalle/@p.Id">
                                        👁️
                                    </a>
                                }
                            }
                            else
                            {
                                <span class="text-light">-</span>
                            }
                        </td>

                        <td class="text-center" style="white-space:nowrap;">
                            <button class="btn btn-sm btn-outline-light me-1"
                                    title="Editar"
                                    @onclick="() => Editar(evento.Id)">
                                ✏
                            </button>

                            <button class="btn btn-sm btn-outline-light"
                                    title="Borrar"
                                    @onclick="() => SolicitarConfirmacion(evento)">
                                🗑
                            </button>


                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
@if (mostrarModalConfirmacion)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" @onclick="CancelarConfirmacion"></button>
                </div>
                <div class="modal-body">
                  <p>

                        <p>
                            ¿Estás seguro que querés eliminar el evento con código
                            <strong>@(eventoAEliminar?.Codigo ?? "…")</strong>?
                        </p>
                  </p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelarConfirmacion">Cancelar</button>
                    <button class="btn btn-danger" @onclick="ConfirmarBorrado">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>


}

@if (!string.IsNullOrEmpty(Mensaje))
{
    <div class="alert alert-info mt-3">@Mensaje</div>
}

@code {
    List<EventoListadoDTO>? eventos;
    string Mensaje = "";
    bool mostrarTodos = false;
    EventoListadoDTO? eventoAEliminar;
    bool mostrarModalConfirmacion = false;



    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LeerEventos();
        }
        catch (Exception ex)
        {
            Mensaje = $"Error durante la inicialización: {ex.Message}";
            Console.WriteLine($"[InitError] {ex}");
        }
    }

    private async Task LeerEventos()
    {
        try
        {
            string endpoint = mostrarTodos
               ? "api/evento/ListaEvento"
               : "api/evento/ListaEventoReciente";

            var resp = await Http.Get<List<EventoListadoDTO>>(endpoint);

            if (!resp.Error)
            {
                eventos = resp.Respuesta ?? new List<EventoListadoDTO>();

                eventos = eventos
                    .OrderBy(e =>
                     e.colorEvento == ColorEvento.Rojo ? 0 :
                     e.colorEvento == ColorEvento.Amarillo ? 1 :
                     e.colorEvento == ColorEvento.Verde ? 2 :
                     3 // valor por defecto si no coincide con ninguno
                 )
                .ToList();

            }
            else
            {
                Mensaje = $"Error al obtener eventos: {resp.ObtenerError()}";
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"❌ Error: {ex.Message}";
            Console.WriteLine($"[Error] {ex}");
        }
    }

    private async Task AlternarVista()
    {
        mostrarTodos = !mostrarTodos;
        await LeerEventos();
    }

    private async Task Borrar(EventoListadoDTO evento)
    {
        var resp = await Http.Delete($"api/evento/{evento.Id}");

        if (resp.Error)
        {
            Mensaje = resp.ObtenerError();
        }

        await LeerEventos();
    }

    

    private void SolicitarConfirmacion(EventoListadoDTO evento)
    {
        eventoAEliminar = evento;
        mostrarModalConfirmacion = true;
        StateHasChanged(); // fuerza el render para que se vea el texto
        Console.WriteLine($"Evento seleccionado: {evento.Codigo}");

    }


    private void CancelarConfirmacion()
    {
        eventoAEliminar = null;
        mostrarModalConfirmacion = false;
    }

    private async Task ConfirmarBorrado()
    {
        if (eventoAEliminar is not null)
        {
            var resp = await Http.Delete($"api/evento/{eventoAEliminar.Id}");

            if (resp.Error)
            {
                Mensaje = resp.ObtenerError();
            }

            await LeerEventos();
            eventoAEliminar = null;
        }

        mostrarModalConfirmacion = false;
    }


    private void Editar(int id)
    {
        Nav.NavigateTo($"/eventos/editar/{id}");
    }

    private void IrAGeolocalizacion() 
    { 
        Nav.NavigateTo("/geolocalizacion"); 
    }
}
