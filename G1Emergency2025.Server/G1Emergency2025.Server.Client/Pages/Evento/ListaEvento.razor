@page "/eventos"
@using System.Text.Json
@inject IHttpServicio Http
@inject NavigationManager Nav

<h3 class="text-light">Lista de Eventos</h3>

<div class="mb-3">
    <a class="btn btn-danger me-2"
       href="/eventos/crear"
       title="Nuevo Evento">
        +
    </a>

    <button class="btn btn-outline-light"
            @onclick="AlternarVista">
        @(mostrarTodos
                ? "Ver eventos de las últimas 24 hs"
                : "Ver historial")
    </button>

     <NavLink href="/geolocalizacion" title="Geolocalización" class="text-primary fs-4">
        <i class="fas fa-earth-americas"></i>
    </NavLink>
</div>

@if (eventos == null)
{
    <div class="alert alert-secondary">Buscando...</div>
}
else if (eventos.Count == 0)
{
    <div class="alert alert-warning">No hay Eventos cargados en esta lista</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-bordered text-dark tabla-compacta">


            <thead class="table-dark">
                <tr>
                    
                    
                    <th>Ubicación</th>
                    <th>Teléfono</th>
                    <th>Fecha</th>
                    <th>Paciente</th>
                    <th>Estado</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var evento in eventos)
                {
                    var colorClase = evento.colorEvento switch
                    {
                        ColorEvento.Rojo => "bg-danger",
                        ColorEvento.Amarillo => "bg-warning text-dark",
                        ColorEvento.Verde => "bg-success",
                        _ => "bg-secondary"
                    };

                    <tr class="@colorClase" @key="evento.Id">
                        <td>@evento.Ubicacion</td>
                        <td>@evento.Telefono</td>
                        <td>
                            @evento.FechaHora.ToString("dd/MM/yyyy") <br />
                            <small class="text-light">@evento.FechaHora.ToString("HH:mm:ss")</small>
                        </td>

                        <td class="text-center align-middle p-0">
                            @if (evento.Pacientes != null && evento.Pacientes.Count > 0)
                            {
                                <NavLink class="btn btn-sm btn-outline-dark px-1 py-0 text-dark"
                                         href="@($"/pacientes/{evento.Id}")"
                                         title="Ver pacientes">
                                    <i class="fa-solid fa-eye text-dark"></i>
                                </NavLink>
                            }
                            else
                            {
                                <span class="text-dark">–</span>
                            }
                        </td>

                        <td class="estado-col text-center align-middle">
                            @if (evento.TipoEstado == "Finalizado")
                            {
                                <span class="text-muted">@evento.TipoEstado</span>
                            }
                            else
                            {
                                <select class="form-select form-select-sm text-dark"
                                        @onchange="e => CambiarEstado(evento.Id, int.Parse(e.Value!.ToString()))">
                                    @foreach (var estado in estadosDisponibles)
                                    {
                                        <option value="@estado.Id" selected="@((estado.Id == evento.TipoEstadoId) ? "selected" : null)">
                                            @estado.TipoEstado
                                        </option>
                                    }
                                </select>
                            }
                        </td>

                        <td class="text-center" style="white-space:nowrap;">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-light" title="Ver evento" @onclick="() => VerEventoPorCodigo(evento.Codigo)">📄</button>
                                <button class="btn btn-sm btn-outline-light me-1" title="Editar" @onclick="() => Editar(evento.Id)">✏</button>
                                <button class="btn btn-sm btn-outline-light me-1" title="Borrar" @onclick="() => SolicitarConfirmacion(evento)">🗑</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>
}
@if (mostrarModalConfirmacion)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" @onclick="CancelarConfirmacion"></button>
                </div>
                <div class="modal-body">
                  

                        <p>
                            ¿Estás seguro que querés eliminar el evento con código
                            <strong>@(eventoAEliminar?.Codigo ?? "…")</strong>?
                        </p>
                  
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelarConfirmacion">Cancelar</button>
                    <button class="btn btn-danger" @onclick="ConfirmarBorrado">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>


}

@if (!string.IsNullOrEmpty(Mensaje))
{
    <div class="alert alert-info mt-3">@Mensaje</div>
}

@code {
    List<EventoDiagPresuntivoListadoDTO>? eventos;
    string Mensaje = "";
    bool mostrarTodos = false;
    EventoDiagPresuntivoListadoDTO? eventoAEliminar;
    bool mostrarModalConfirmacion = false;

    // 🔹 Estados disponibles desde el backend
    List<TipoEstadoListadoDTO> estadosDisponibles = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var respEstados = await Http.Get<List<TipoEstadoListadoDTO>>("api/tipoEstado/ListaTipoEstado");
            if (!respEstados.Error)
            {
                estadosDisponibles = respEstados.Respuesta ?? new();
            }

            await LeerEventos();
        }
        catch (Exception ex)
        {
            Mensaje = $"Error durante la inicialización: {ex.Message}";
            Console.WriteLine($"[InitError] {ex}");
        }
    }


    private async Task LeerEventos()
    {
        try
        {
            string endpoint = mostrarTodos
               ? "api/evento/ListaEvento"
               : "api/evento/ListaEventoReciente";

            var resp = await Http.Get<List<EventoDiagPresuntivoListadoDTO>>(endpoint);

            if (!resp.Error)
            {
                eventos = resp.Respuesta ?? new List<EventoDiagPresuntivoListadoDTO>();

                // 🔹 Filtrar: excluir los eventos finalizados
                eventos = eventos
                    .Where(e => e.TipoEstado != "Finalizado")
                    .OrderBy(e =>
                        e.colorEvento == ColorEvento.Rojo ? 0 :
                        e.colorEvento == ColorEvento.Amarillo ? 1 :
                        e.colorEvento == ColorEvento.Verde ? 2 :
                        3)
                    .ToList();
            }
            else
            {
                Mensaje = $"Error al obtener eventos: {resp.ObtenerError()}";
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"❌ Error: {ex.Message}";
            Console.WriteLine($"[Error] {ex}");
        }
    }

    private async Task CambiarEstado(int eventoId, int nuevoEstadoId)
    {
        var dto = new ActualizarEstadoEventoDTO { TipoEstadoId = nuevoEstadoId };

        var resp = await Http.Put<ActualizarEstadoEventoDTO, object>(
            $"api/evento/{eventoId}/estadoEvento", dto);

        if (!resp.Error)
        {
            var eventoActual = eventos?.FirstOrDefault(e => e.Id == eventoId);
            if (eventoActual is not null)
            {
                eventoActual.TipoEstadoId = nuevoEstadoId;
                var estado = estadosDisponibles.FirstOrDefault(e => e.Id == nuevoEstadoId);
                if (estado != null)
                {
                    eventoActual.TipoEstado = estado.TipoEstado;
                }

                if (eventoActual.TipoEstado == "Finalizado")
                {
                    eventos!.Remove(eventoActual);
                }
            }

            StateHasChanged();
        }
        else
        {
            Mensaje = $"Error al cambiar estado: {resp.ObtenerError()}";
        }
    }


    private async Task AlternarVista()
    {
        mostrarTodos = !mostrarTodos;
        await LeerEventos();
    }

    private async Task Borrar(EventoDiagPresuntivoListadoDTO evento)
    {
        var resp = await Http.Delete($"api/evento/{evento.Id}");

        if (resp.Error)
        {
            Mensaje = resp.ObtenerError();
        }

        await LeerEventos();
    }

    private void SolicitarConfirmacion(EventoDiagPresuntivoListadoDTO evento)
    {
        eventoAEliminar = evento;
        mostrarModalConfirmacion = true;
        StateHasChanged();
        Console.WriteLine($"Evento seleccionado: {evento.Codigo}");
    }

    private void CancelarConfirmacion()
    {
        eventoAEliminar = null;
        mostrarModalConfirmacion = false;
    }

    private async Task ConfirmarBorrado()
    {
        if (eventoAEliminar is not null)
        {
            var resp = await Http.Delete($"api/evento/{eventoAEliminar.Id}");

            if (resp.Error)
            {
                Mensaje = resp.ObtenerError();
            }

            await LeerEventos();
            eventoAEliminar = null;
        }

        mostrarModalConfirmacion = false;
    }

    private void Editar(int id)
    {
        Nav.NavigateTo($"/eventos/editar/{id}");
    }

    private void IrAGeolocalizacion()
    {
        Nav.NavigateTo("/geolocalizacion");
    }

    

    private void VerEventoPorCodigo(string codigo)
    {
        Nav.NavigateTo($"/evento/codigo/{codigo}");
    }

}
