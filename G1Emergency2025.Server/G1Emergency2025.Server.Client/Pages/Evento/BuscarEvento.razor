@page "/eventos/buscar"
@inject IHttpServicio Http
@inject NavigationManager Nav

<h3 class="text-light">Buscar Eventos por Fecha</h3>

<div class="card bg-dark text-light mb-3">
    <div class="card-body">
        <h5 class="card-title">Filtros de búsqueda</h5>
        <div class="row g-2">
            <div class="col-md-2">
                <InputNumber @bind-Value="anioFiltro" class="form-control" placeholder="Año" />
            </div>
            <div class="col-md-2">
                <InputNumber @bind-Value="mesFiltro" class="form-control" placeholder="Mes" />
            </div>
            <div class="col-md-2">
                <InputNumber @bind-Value="diaFiltro" class="form-control" placeholder="Día" />
            </div>
            <div class="col-md-2">
                <InputNumber @bind-Value="horaFiltro" class="form-control" placeholder="Hora" />
            </div>
            <div class="col-md-2">
                <button class="btn btn-info w-100" @onclick="BuscarPorFecha">Buscar</button>
            </div>
        </div>
    </div>
</div>

@if (eventos == null)
{
    <div class="alert alert-secondary">Esperando búsqueda...</div>
}
else if (eventos.Count == 0)
{
    <div class="alert alert-warning">No se encontraron eventos con esos filtros</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-sm table-bordered text-dark tabla-compacta">
            <thead class="table-dark">
                <tr>
                    <th>Ubicación</th>
                    <th>Teléfono</th>
                    <th>Fecha</th>
                    <th>Paciente</th>
                    <th style="min-width: 160px;">Estado</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var evento in eventos)
                {
                    var colorClase = evento.colorEvento switch
                    {
                        ColorEvento.Rojo => "bg-danger",
                        ColorEvento.Amarillo => "bg-warning text-dark",
                        ColorEvento.Verde => "bg-success",
                        _ => "bg-secondary"
                    };

                    <tr class="@colorClase" @key="evento.Id">
                        <td>@evento.Ubicacion</td>
                        <td>@evento.Telefono</td>
                        <td>
                            @evento.FechaHora.ToString("dd/MM/yyyy") <br />
                            <small class="text-light">@evento.FechaHora.ToString("HH:mm:ss")</small>
                        </td>
                        <td class="text-center align-middle p-0">
                            @if (evento.Pacientes != null && evento.Pacientes.Count > 0)
                            {
                                <NavLink class="btn btn-sm btn-outline-dark px-1 py-0 text-dark"
                                         href="@($"/pacientes/{evento.Id}")"
                                         title="Ver pacientes">
                                    <i class="fa-solid fa-eye text-dark"></i>
                                </NavLink>
                            }
                            else
                            {
                                <span class="text-dark">–</span>
                            }
                        </td>
                        <td class="align-middle">
                            @if (evento.TipoEstado == "Finalizado")
                            {
                                <span class="text-muted">@evento.TipoEstado</span>
                            }
                            else
                            {
                                <select class="form-select form-select-sm bg-light text-dark"
                                        style="font-size: 0.85rem;"
                                        @onchange="e => CambiarEstado(evento.Id, int.Parse(e.Value!.ToString()))">
                                    @foreach (var estado in estadosDisponibles)
                                    {
                                        <option value="@estado.Id" selected="@((estado.Id == evento.TipoEstadoId) ? "selected" : null)">
                                            @estado.TipoEstado
                                        </option>
                                    }
                                </select>
                            }
                        </td>
                        <td class="text-center" style="white-space:nowrap;">
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-light" title="Ver evento" @onclick="() => VerEventoPorCodigo(evento.Codigo)">📄</button>
                                <button class="btn btn-sm btn-outline-light me-1" title="Editar" @onclick="() => Editar(evento.Id)">✏</button>
                                <button class="btn btn-sm btn-outline-light me-1" title="Asignar Móvil" @onclick="() => AsignarMovil(evento.Id)">🚑</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<div class="mt-4">
    <button class="btn btn-secondary" @onclick="Volver">← Volver a lista</button>
</div>

@if (!string.IsNullOrEmpty(Mensaje))
{
    <div class="alert alert-info mt-3">@Mensaje</div>
}

@code {
    int? anioFiltro;
    int? mesFiltro;
    int? diaFiltro;
    int? horaFiltro;

    List<EventoDiagPresuntivoListadoDTO>? eventos;
    List<TipoEstadoListadoDTO> estadosDisponibles = new();
    string Mensaje = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var respEstados = await Http.Get<List<TipoEstadoListadoDTO>>("api/tipoEstado/ListaTipoEstado");
            if (!respEstados.Error)
            {
                estadosDisponibles = respEstados.Respuesta ?? new();
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al cargar estados: {ex.Message}";
        }
    }

    private async Task BuscarPorFecha()
    {
        try
        {
            string endpoint = $"api/evento/buscarPorFecha?anio={anioFiltro}&mes={mesFiltro}&dia={diaFiltro}&hora={horaFiltro}";
            var resp = await Http.Get<List<EventoDiagPresuntivoListadoDTO>>(endpoint);

            if (!resp.Error)
            {
                eventos = resp.Respuesta ?? new List<EventoDiagPresuntivoListadoDTO>();
            }
            else
            {
                Mensaje = $"Error al buscar eventos: {resp.ObtenerError()}";
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"❌ Error: {ex.Message}";
        }
    }

    private async Task CambiarEstado(int eventoId, int estadoId)
    {
        var dto = new AsignarMovilesEventoDTO { Id = eventoId, EstadoId = estadoId };

        var response = await Http.Put<AsignarMovilesEventoDTO, object>(
            $"api/evento/{eventoId}/AsignarMovilesEvento", dto);

        if (!response.Error)
        {
            var evento = eventos!.FirstOrDefault(e => e.Id == eventoId);
            if (evento != null)
            {
                var nuevoEstado = estadosDisponibles.FirstOrDefault(e => e.Id == estadoId);
                if (nuevoEstado != null)
                    evento.TipoEstado = nuevoEstado.TipoEstado;
            }
        }
    }

    private void Editar(int id)
    {
        Nav.NavigateTo($"/eventos/editar/{id}");
    }

    private void AsignarMovil(int eventoId)
    {
        Nav.NavigateTo($"/geolocalizacion/{eventoId}");
    }

    private void VerEventoPorCodigo(string codigo)
    {
        Nav.NavigateTo($"/evento/codigo/{codigo}");
    }

    private void Volver()
    {
        Nav.NavigateTo("/eventos");
    }
}

