@page "/eventos/editar/{Id:int}"
@inject IHttpServicio Http
@inject NavigationManager Nav

<h3 class="text-light">Editar Evento @evento?.Codigo</h3>

@if (cargando)
{
    <p class="text-light">Cargando datos...</p>
}
else if (evento == null)
{
    <p class="text-light">No se encontró el evento.</p>
}
else
{
    <EditForm Model="@evento" OnValidSubmit="MostrarConfirmacion">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label text-light">Teléfono</label>
                <InputText class="form-control" @bind-Value="evento.Telefono" />
                <ValidationMessage For="@(() => evento.Telefono)" />
            </div>

            <div class="col-md-5">
                <label class="form-label text-light">Ubicación</label>
                <InputText class="form-control" @bind-Value="evento.Ubicacion" />
                <ValidationMessage For="@(() => evento.Ubicacion)" />
            </div>

            <div class="col-md-3">
                <label class="form-label text-light">Fecha y Hora</label>
                <InputDate class="form-control" @bind-Value="evento.FechaHora" />
                <ValidationMessage For="@(() => evento.FechaHora)" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label text-light">Relato</label>
            <InputTextArea class="form-control" @bind-Value="evento.Relato" />
        </div>

        <div class="row mb-3 align-items-center">
            <div class="col-md-4">
                <label class="form-label text-light">Color del Evento</label>
                <InputRadioGroup @bind-Value="evento.colorEvento">
                    <div class="d-flex gap-3">
                        <div>
                            <InputRadio class="d-none" id="colorVerde" Value="ColorEvento.Verde" />
                            <label for="colorVerde">
                                <span class="@GetCircleClass(ColorEvento.Verde)"
                                      style="width: 24px; height: 24px; background-color: green; cursor: pointer;"></span>
                            </label>
                        </div>
                        <div>
                            <InputRadio class="d-none" id="colorRojo" Value="ColorEvento.Rojo" />
                            <label for="colorRojo">
                                <span class="@GetCircleClass(ColorEvento.Rojo)"
                                      style="width: 24px; height: 24px; background-color: red; cursor: pointer;"></span>
                            </label>
                        </div>
                        <div>
                            <InputRadio class="d-none" id="colorAmarillo" Value="ColorEvento.Amarillo" />
                            <label for="colorAmarillo">
                                <span class="@GetCircleClass(ColorEvento.Amarillo)"
                                      style="width: 24px; height: 24px; background-color: yellow; cursor: pointer;"></span>
                            </label>
                        </div>
                    </div>
                </InputRadioGroup>
                <ValidationMessage For="@(() => evento.colorEvento)" />
            </div>

            <div class="col-md-4">
                <label class="form-label text-light">Estado</label>
                <InputSelect class="form-control" @bind-Value="evento.TipoEstadoId">
                    <option value="0">-- Seleccionar estado --</option>
                    @foreach (var e in tipoestados)
                    {
                        <option value="@e.Id">@($"{e.Codigo} - {e.Tipo}")</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => evento.TipoEstadoId)" />
            </div>

            <div class="col-md-4">
                <label class="form-label text-light">Causa</label>
                <InputSelect class="form-control" @bind-Value="evento.CausaId">
                    <option value="0">-- Seleccionar causa --</option>
                    @foreach (var c in causas)
                    {
                        <option value="@c.Id">@($"{c.Codigo} - {c.posibleCausa}")</option>
                    }
                </InputSelect>
                <ValidationMessage For="@(() => evento.CausaId)" />
            </div>
        </div>

        <div class="mt-4 d-flex flex-wrap gap-2">
            <button class="btn btn-success" type="submit">Guardar</button>
            <button class="btn btn-secondary" type="button" @onclick="Volver">Cancelar</button>
        </div>
    </EditForm>

    @if (mostrarModalConfirmacion)
    {
        <div class="modal show d-block" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">Confirmar cambios</h5>
                        <button type="button" class="btn-close" @onclick="CancelarConfirmacion"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro que querés realizar este cambio?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CancelarConfirmacion">Cancelar</button>
                        <button class="btn btn-primary" @onclick="GuardarCambios">Guardar</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop fade show"></div>
    }
}

<p>@Mensaje</p>

@code {
    [Parameter] public string vista { get; set; } = "recientes";
    [Parameter] public int Id { get; set; }
    private EventoActualizarDTO? evento;
    private List<TipoEstadoDTO> tipoestados = new();
    private List<CausaDTO> causas = new();
    private string Mensaje = "";
    private bool cargando = true;
    private bool mostrarModalConfirmacion = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var respTipoEstados = await Http.Get<List<TipoEstadoDTO>>("api/tipoestado");
            if (!respTipoEstados.Error) tipoestados = respTipoEstados.Respuesta!;
            var respCausas = await Http.Get<List<CausaDTO>>("api/causa");
            if (!respCausas.Error) causas = respCausas.Respuesta!;

            var respEvento = await Http.Get<EventoActualizarDTO>($"api/evento/id/{Id}");
            if (!respEvento.Error && respEvento.Respuesta is not null)
            {
                evento = respEvento.Respuesta!;
            }
            else
            {
                Mensaje = respEvento.ObtenerError();
            }
        }
        catch (Exception ex)
        {
            Mensaje = $"Error al cargar datos: {ex.Message}";
        }

        cargando = false;
    }

    private void MostrarConfirmacion()
    {
        mostrarModalConfirmacion = true;
    }

    private void CancelarConfirmacion()
    {
        mostrarModalConfirmacion = false;
    }

    private async Task GuardarCambios()
    {
        mostrarModalConfirmacion = false;

        var dto = new EventoActualizarDTO
        {
            Id = evento!.Id,
            Relato = evento.Relato,
            colorEvento = evento.colorEvento,
            Ubicacion = evento.Ubicacion,
            Telefono = evento.Telefono,
            FechaHora = evento.FechaHora,
            CausaId = evento.CausaId,
            TipoEstadoId = evento.TipoEstadoId
        };

        var respEvento = await Http.Put<EventoActualizarDTO, bool>($"api/evento/{Id}/pacienteEvento", dto);
        if (respEvento.Error)
        {
            Mensaje = respEvento.ObtenerError();
            return;
        }

        Nav.NavigateTo($"/eventos?vista={vista}", forceLoad: true);
    }

    private string GetCircleClass(ColorEvento color)
    {
        if (evento!.colorEvento == color)
            return "rounded-circle d-inline-block border border-3 border-white";

        return "rounded-circle d-inline-block border border-2 border-dark shadow";
    }

    private void Volver()
    {
        Nav.NavigateTo($"/eventos?vista={vista}");
    }
}
