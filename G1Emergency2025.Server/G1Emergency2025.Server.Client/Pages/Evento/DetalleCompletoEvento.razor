@page "/evento/codigo/{codigo}"
@inject IHttpServicio Http

<h3 class="text-light">Evento @evento?.Codigo</h3>

@if (cargando)
{
    <div class="alert alert-info">Cargando evento...</div>
}
else if (evento == null)
{
    <div class="alert alert-warning">No se encontró el evento.</div>
}
else
{
    <div class="card bg-white text-dark mb-3" style="max-width: 600px;">
        <div class="card-body py-2 px-3">
           

            <p><strong>Ubicación:</strong> @evento.Ubicacion</p>
            <p><strong>Teléfono:</strong> @evento.Telefono</p>
            <p><strong>Fecha:</strong> @evento.FechaHora.ToString("dd/MM/yyyy HH:mm")</p>
            <p><strong>Causa:</strong> @evento.Causa</p>
            <p><strong>Estado:</strong> @evento.TipoEstado</p>
            @if (!string.IsNullOrWhiteSpace(evento.DiagnosticoPresuntivo))
            {
                <p><strong>Diagnóstico Presuntivo:</strong> @evento.DiagnosticoPresuntivo</p>
            }
            @if (!string.IsNullOrWhiteSpace(evento.Relato))
            {
                <p><strong>Relato:</strong> @evento.Relato</p>
            }

            <!-- Color del evento como círculo -->
            <p>
                <strong>Color:</strong>
                <span class="@GetCircleClass(evento.colorEvento)"
                      style="width: 24px; height: 24px; display:inline-block; background-color:@GetColorHex(evento.colorEvento);">
                </span>
            </p>

            <!-- Móviles asignados -->
            @if (evento.Moviles.Any())
            {
                <p><strong>Móviles asignados:</strong></p>
                <ul class="list-group mb-2">
                    @foreach (var m in evento.Moviles)
                    {
                        <li class="list-group-item">@m.Patente - @m.TipoMovil</li>
                    }
                </ul>
            }

            <!-- Usuarios -->
            @if (evento.Usuarios.Any())
            {
                <p><strong>Usuarios involucrados:</strong></p>
                <ul class="list-group mb-2">
                    @foreach (var u in evento.Usuarios)
                    {
                        <li class="list-group-item">@u.Nombre </li>
                    }
                </ul>
            }

            <!-- Lugares -->
            @if (evento.Lugares.Any())
            {
                <p><strong>Lugares relacionados:</strong></p>
                <ul class="list-group mb-2">
                    @foreach (var l in evento.Lugares)
                    {
                        <li class="list-group-item">@l.Descripcion</li>
                    }
                </ul>
            }

            <!-- Historial -->
            @if (evento.Historial.Any())
            {
                <p><strong>Historial de modificaciones:</strong></p>
                <ul class="list-group mb-2">
                    @foreach (var h in evento.Historial)
                    {
                        <li class="list-group-item">
                            @h.UsuarioNombre:
                            @(h.CreoEvento ? "Creó el evento" : "") @(h.ModificoEvento ? $" - Modificó ({h.CantidadModificaciones} veces)" : "")
                        </li>
                    }
                </ul>
            }
        </div>
    </div>


    <NavLink class="btn btn-secondary mt-3" href="/eventos">
        <i class="bi bi-arrow-left"></i> Volver a eventos
    </NavLink>
}

@code {
    [Parameter] public string codigo { get; set; } = string.Empty;
    private EventoDiagPresuntivoListadoDTO? evento;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        var resp = await Http.Get<EventoDiagPresuntivoListadoDTO>($"api/evento/EventoPorCodigo/{codigo}");
        if (!resp.Error)
        {
            evento = resp.Respuesta;
        }
        cargando = false;
    }

    private string GetCircleClass(ColorEvento color)
    {
        return "rounded-circle border border-2 border-dark shadow";
    }

    private string GetColorHex(ColorEvento color)
    {
        return color switch
        {
            ColorEvento.Verde => "green",
            ColorEvento.Rojo => "red",
            ColorEvento.Amarillo => "yellow",
            _ => "gray"
        };
    }

}
