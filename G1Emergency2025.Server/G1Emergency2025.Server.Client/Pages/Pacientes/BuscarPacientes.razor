@page "/pacientes/buscar"
@inject IHttpServicio Http
@inject NavigationManager Nav

<h3 class="text-light">Buscar Pacientes</h3>

<div class="row mb-3">
    <div class="col-md-4">
        <label class="form-label text-light">DNI</label>
        <InputText class="form-control" @bind-Value="dni" />
        <button class="btn btn-success mt-2" @onclick="BuscarPorDni">Buscar por DNI</button>
    </div>
    <div class="col-md-4">
        <label class="form-label text-light">Historia Clínica</label>
        <InputText class="form-control" @bind-Value="historiaClinica" />
        <button class="btn btn-success mt-2" @onclick="BuscarPorHistoriaClinica">Buscar por HC</button>
    </div>
    <div class="col-md-4">
        <label class="form-label text-light">Nombre</label>
        <InputText class="form-control" @bind-Value="nombre" />
        <button class="btn btn-success mt-2" @onclick="BuscarPorNombre">Buscar por Nombre</button>
    </div>
</div>

@if (pacientesResultado is not null && pacientesResultado.Any())
{
    <h5 class="text-light mt-4">Pacientes encontrados</h5>
    <table class="table table-sm table-bordered text-dark">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>DNI</th>
                <th>Historia Clínica</th>
                <th>Dirección</th>
                <th>Sexo</th>
                <th>Edad</th>
                <th>Eventos</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var paciente in pacientesResultado)
            {
                <tr>
                    <td>@paciente.Nombre</td>
                    <td>@paciente.DNI</td>
                    <td>@(string.IsNullOrWhiteSpace(paciente.HistoriaClinica) ? "Ninguna" : paciente.HistoriaClinica)</td>
                    <td>@paciente.Direccion</td>
                    <td>@paciente.Sexo</td>
                    <td>@paciente.Edad</td>
                    <td>
                        @if (paciente.Eventos != null && paciente.Eventos.Any())
                        {
                            @foreach (var ev in paciente.Eventos)
                            {
                                <NavLink class="btn btn-sm btn-outline-dark me-1"
                                         href="@($"/evento/codigo/{ev.Codigo}")"
                                         title="Visualizar Evento">
                                    Visualizar evento: @ev.Codigo
                                </NavLink>
                            }
                        }
                        else
                        {
                            <span class="text-muted">Sin eventos</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else if (busquedaEjecutada)
{
    <div class="alert alert-warning mt-3">No se encontraron pacientes.</div>
}

@code {
    string dni = "";
    string historiaClinica = "";
    string nombre = "";

    bool busquedaEjecutada = false;

    class PacienteResultadoDTO
    {
        public string Nombre { get; set; } = "";
        public string DNI { get; set; } = "";
        public string HistoriaClinica { get; set; } = "";
        public string Direccion { get; set; } = "";
        public string Sexo { get; set; } = "";
        public string Edad { get; set; } = "";
        public List<EventoResumenDTO>? Eventos { get; set; }
    }

    class EventoResumenDTO
    {
        public string Codigo { get; set; } = "";
    }

    List<PacienteResultadoDTO>? pacientesResultado;

    private async Task BuscarPorDni()
    {
        busquedaEjecutada = true;
        pacientesResultado = new();

        var respPersona = await Http.Get<PersonaDTO>($"api/persona/dni/{dni}");
        if (!respPersona.Error && respPersona.Respuesta is not null)
        {
            var persona = respPersona.Respuesta;
            var respEventos = await Http.Get<List<EventoDiagPresuntivoListadoDTO>>($"api/evento/ListaEventoPorDNIPaciente/{dni}");

            pacientesResultado.Add(new PacienteResultadoDTO
            {
                Nombre = persona.Nombre,
                DNI = persona.DNI,
                Direccion = persona.Direccion,
                Sexo = persona.Sexo.ToString(),
                Edad = persona.Edad,
                Eventos = respEventos.Respuesta?.Select(e => new EventoResumenDTO { Codigo = e.Codigo }).ToList()
            });
        }
    }

    private async Task BuscarPorHistoriaClinica()
    {
        busquedaEjecutada = true;
        pacientesResultado = new();

        var respEventos = await Http.Get<List<EventoDiagPresuntivoListadoDTO>>($"api/evento/ListaEventoPorHistoriaClinicaPaciente/{historiaClinica}");
        if (!respEventos.Error && respEventos.Respuesta is not null)
        {
            foreach (var ev in respEventos.Respuesta)
            {
                foreach (var p in ev.Pacientes)
                {
                    pacientesResultado.Add(new PacienteResultadoDTO
                    {
                        Nombre = p.NombrePersona,
                        DNI = p.DNIPersona,
                        Direccion = p.DireccionPersona,
                        Sexo = p.SexoPersona.ToString(),
                        Edad = p.EdadPersona,
                        HistoriaClinica = p.HistoriaClinica ?? "",
                        Eventos = new List<EventoResumenDTO> { new EventoResumenDTO { Codigo = ev.Codigo } }
                    });
                }
            }
        }
    }

    private async Task BuscarPorNombre()
    {
        busquedaEjecutada = true;
        pacientesResultado = new();

        var respEventos = await Http.Get<List<EventoDiagPresuntivoListadoDTO>>($"api/evento/EventoPorNombrePaciente?nombre={nombre}");
        if (!respEventos.Error && respEventos.Respuesta is not null)
        {
            foreach (var ev in respEventos.Respuesta)
            {
                foreach (var p in ev.Pacientes)
                {
                    pacientesResultado.Add(new PacienteResultadoDTO
                    {
                        Nombre = p.NombrePersona,
                        DNI = p.DNIPersona,
                        Direccion = p.DireccionPersona,
                        Sexo = p.SexoPersona.ToString(),
                        Edad = p.EdadPersona,
                        HistoriaClinica = p.HistoriaClinica ?? "",
                        Eventos = new List<EventoResumenDTO> { new EventoResumenDTO { Codigo = ev.Codigo } }
                    });
                }
            }
        }
    }
}

